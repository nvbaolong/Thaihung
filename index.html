<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Bán Hàng</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>

<body class="bg-gray-100 font-sans">

    <div class="flex h-screen bg-gray-100">
        <aside class="sidebar bg-white shadow-lg transition-all duration-300">
            <div class="h-16 flex items-center justify-center border-b">
                <h1 class="text-2xl font-bold text-gray-800">Dashboard</h1>
            </div>
            <nav class="mt-4">
                <ul id="main-tabs" class="flex flex-col p-2 space-y-1">
                    <li>
                        <a href="index.html" class="flex items-center p-3 rounded-lg sidebar-item sidebar-active">
                            <i class="fas fa-cash-register w-6 text-center"></i>
                            <span class="ml-3">Bán Hàng</span>
                        </a>
                    </li>
                    <li>
                        <a href="history.html" class="flex items-center p-3 rounded-lg sidebar-item">
                            <i class="fas fa-history w-6 text-center"></i>
                            <span class="ml-3">Lịch Sử & Công Nợ</span>
                        </a>
                    </li>
                    <li>
                        <a href="manage.html" class="flex items-center p-3 rounded-lg sidebar-item">
                            <i class="fas fa-boxes-stacked w-6 text-center"></i>
                            <span class="ml-3">Quản Lý Hàng Hóa</span>
                        </a>
                    </li>
                    <li>
                        <a href="customers.html" class="flex items-center p-3 rounded-lg sidebar-item">
                            <i class="fas fa-users w-6 text-center"></i>
                            <span class="ml-3">Khách Hàng</span>
                        </a>
                    </li>
                    <li>
                        <a href="purchase.html" class="flex items-center p-3 rounded-lg sidebar-item">
                            <i class="fas fa-dolly w-6 text-center"></i>
                            <span class="ml-3">Nhập Hàng</span>
                        </a>
                    </li>
                </ul>
            </nav>
        </aside>

        <main class="flex-1 flex flex-col overflow-hidden">
            <header class="h-16 flex items-center justify-between px-6 bg-white border-b">
                <h2 id="page-title" class="text-2xl font-semibold text-gray-900">Tạo Đơn Hàng</h2>
                <div class="flex space-x-2">
                    <button id="sync-btn" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded">
                        <i class="fas fa-cloud-upload-alt mr-1"></i> Sao lưu
                    </button>
                    <button id="restore-btn" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded">
                        <i class="fas fa-history mr-1"></i> Khôi phục
                    </button>
                    <button id="export-all-btn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">
                        <i class="fas fa-file-export mr-1"></i> Xuất Dữ Liệu
                    </button>
                    <button id="import-all-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">
                        <i class="fas fa-file-import mr-1"></i> Nhập Dữ Liệu
                    </button>
                    <input type="file" id="import-all-input" class="hidden" accept=".xlsx">
                </div>

            </header>

            <div id="tab-content" class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-4 sm:p-6 lg:p-8">
                <div id="sales-tab" class="tab-pane">
                    <div id="invoice-tabs-container"
                        class="flex items-center border-b border-gray-200 bg-gray-50 rounded-t-lg">
                        <button id="new-invoice-btn"
                            class="px-4 py-2 text-lg font-bold text-blue-500 hover:bg-blue-100 rounded-tr-lg">+</button>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div
                            class="lg:col-span-2 bg-white p-6 rounded-b-lg lg:rounded-bl-lg lg:rounded-br-none shadow-md flex flex-col">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-bold text-gray-900">Thông tin đơn hàng</h3>
                                <div class="flex items-center">
                                    <span class="mr-3 text-sm font-medium text-gray-900">Giá Lẻ</span>
                                    <label for="price-toggle" class="inline-flex relative items-center cursor-pointer">
                                        <input type="checkbox" id="price-toggle" class="sr-only peer">
                                        <div
                                            class="w-11 h-6 bg-gray-200 rounded-full peer peer-focus:ring-2 peer-focus:ring-blue-300 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600">
                                        </div>
                                    </label>
                                    <span class="ml-3 text-sm font-medium text-gray-900">Giá Sỉ</span>
                                </div>
                            </div>

                            <div class="flex items-center space-x-2 mb-4">
                                <div class="relative flex-grow">
                                    <label for="order-product-search" class="sr-only">Tìm sản phẩm</label>
                                    <i
                                        class="fas fa-search absolute left-3 top-3 text-gray-400 pointer-events-none"></i>
                                    <input type="text" id="order-product-search"
                                        placeholder="Nhập tên hoặc mã sản phẩm để thêm vào đơn..."
                                        class="w-full pl-10 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <div id="autocomplete-results"
                                        class="absolute z-20 w-full bg-white border rounded-lg mt-1 max-h-60 overflow-y-auto hidden shadow-lg">
                                    </div>
                                </div>
                                <button id="quick-add-product-btn"
                                    class="flex-shrink-0 bg-green-500 text-white px-3 py-2 rounded-lg font-semibold hover:bg-green-600"><i
                                        class="fas fa-plus"></i></button>
                            </div>

                            <div id="customer-name-wrapper" class="hidden mb-4">
                                <div class="flex items-center space-x-2">
                                    <div class="relative flex-grow">
                                        <label for="customer-name-search" class="sr-only">Tìm khách hàng</label>
                                        <i
                                            class="fas fa-user absolute left-3 top-3 text-gray-400 pointer-events-none"></i>
                                        <input type="text" id="customer-name-search"
                                            placeholder="Tìm hoặc nhập tên khách hàng..."
                                            class="w-full pl-10 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <div id="customer-autocomplete-results"
                                            class="absolute z-10 w-full bg-white border rounded-lg mt-1 max-h-60 overflow-y-auto hidden shadow-lg">
                                        </div>
                                    </div>
                                    <button id="quick-add-customer-btn"
                                        class="flex-shrink-0 bg-blue-500 text-white px-3 py-2 rounded-lg font-semibold hover:bg-blue-600"><i
                                            class="fas fa-plus"></i></button>
                                </div>
                            </div>

                            <div class="flex-grow min-h-[300px] max-h-[50vh] overflow-y-auto">
                                <div id="current-order-items">
                                    <p class="text-gray-900 text-center py-4">Chưa có sản phẩm nào</p>
                                </div>
                            </div>
                        </div>

                        <div id="payment-summary-section" class="lg:col-span-1">
                            <div class="bg-white p-6 rounded-lg shadow-md sticky top-8">
                                <h3 class="text-xl font-bold text-gray-900 mb-4">Thanh Toán</h3>

                                <div class="flex justify-between items-center text-2xl mb-4 pb-4 border-b">
                                    <span class="font-medium text-gray-600">Tổng tiền:</span>
                                    <span id="summary-total" class="font-bold text-blue-600">0 VNĐ</span>
                                </div>

                                <div id="customer-debt-display" class="hidden text-sm text-gray-600 mb-4 pb-4 border-b">
                                    <div class="flex justify-between">
                                        <span>Nợ hiện tại của khách:</span>
                                        <span id="customer-current-debt" class="font-medium text-red-500">0 VNĐ</span>
                                    </div>
                                </div>

                                <div id="debt-controls" class="space-y-4">
                                    <div>
                                        <label for="amount-paid" class="block text-sm font-medium text-gray-700 mb-1">Đã
                                            trả:</label>
                                        <div class="relative">
                                            <input type="text" id="amount-paid" placeholder="0"
                                                class="w-full pl-3 pr-20 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-right text-lg">
                                            <button id="pay-all-btn"
                                                class="absolute inset-y-0 right-0 flex items-center px-3 text-sm font-semibold text-blue-600 bg-blue-100 hover:bg-blue-200 rounded-r-lg">Trả
                                                hết</button>
                                        </div>
                                    </div>
                                    <div id="debt-row" class="flex justify-between items-center text-xl text-red-600">
                                        <span class="font-medium">Còn lại (Ghi nợ):</span>
                                        <span id="debt-amount" class="font-bold">0 VNĐ</span>
                                    </div>
                                </div>

                                <div class="pt-6 mt-6 border-t space-y-2">
                                    <button id="save-order-btn"
                                        class="w-full bg-green-500 text-white py-3 rounded-lg font-semibold hover:bg-green-600 transition duration-300 disabled:bg-gray-400">
                                        <i class="fas fa-save mr-2"></i>Lưu Đơn Hàng
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="order-detail-modal"
        class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-10 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex justify-between items-center border-b pb-3 mb-4">
                    <h3 class="text-xl leading-6 font-medium text-gray-900" id="detail-modal-title">Chi Tiết Đơn Hàng
                    </h3>
                    <button id="close-detail-modal-btn" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times fa-lg"></i>
                    </button>
                </div>
                <div id="detail-modal-content">
                </div>
                <div class="items-center px-4 py-3 mt-4 border-t text-right">
                    <button id="print-order-btn"
                        class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-auto shadow-sm hover:bg-blue-600"><i
                            class="fas fa-print mr-2"></i>In Hóa Đơn</button>
                    <button id="close-detail-modal-btn-footer"
                        class="px-4 py-2 bg-gray-300 text-gray-800 text-base font-medium rounded-md w-auto shadow-sm hover:bg-gray-400 ml-2">Đóng</button>
                </div>
            </div>
        </div>
    </div>

    <div id="quick-customer-modal"
        class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900">Thêm Nhanh Khách Hàng</h3>
                <form id="quick-customer-form" class="mt-2 px-7 py-3 space-y-4 text-left">
                    <div>
                        <label for="quick-customer-name" class="block text-sm font-medium text-gray-700">Tên khách
                            hàng:</label>
                        <input type="text" id="quick-customer-name" class="mt-1 w-full px-3 py-2 border rounded-lg"
                            required>
                    </div>
                    <div>
                        <label for="quick-customer-initial-debt" class="block text-sm font-medium text-gray-700">Nợ ban
                            đầu:</label>
                        <input type="text" id="quick-customer-initial-debt" placeholder="0"
                            class="mt-1 w-full px-3 py-2 border rounded-lg text-right">
                    </div>
                </form>
                <div class="items-center px-4 py-3">
                    <button id="save-quick-customer-btn"
                        class="px-4 py-2 bg-green-500 text-white text-base font-medium rounded-md w-auto shadow-sm hover:bg-green-600">Lưu</button>
                    <button id="close-quick-customer-modal-btn"
                        class="px-4 py-2 bg-gray-300 text-gray-800 text-base font-medium rounded-md w-auto shadow-sm hover:bg-gray-400 ml-2">Hủy</button>
                </div>
            </div>
        </div>
    </div>

    <div id="quick-product-modal"
        class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900">Thêm Nhanh Sản Phẩm</h3>
                <form id="quick-product-form" class="mt-2 px-7 py-3 space-y-4 text-left">
                    <div>
                        <label for="quick-product-name" class="block text-sm font-medium text-gray-700">Tên sản
                            phẩm:</label>
                        <input type="text" id="quick-product-name" class="mt-1 w-full px-3 py-2 border rounded-lg"
                            required>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="quick-product-wholesale-price"
                                class="block text-sm font-medium text-gray-700">Giá sỉ:</label>
                            <input type="text" id="quick-product-wholesale-price" placeholder="0"
                                class="mt-1 w-full px-3 py-2 border rounded-lg text-right">
                        </div>
                        <div>
                            <label for="quick-product-retail-price" class="block text-sm font-medium text-gray-700">Giá
                                lẻ:</label>
                            <input type="text" id="quick-product-retail-price" placeholder="0"
                                class="mt-1 w-full px-3 py-2 border rounded-lg text-right">
                        </div>
                    </div>
                </form>
                <div class="items-center px-4 py-3">
                    <button id="save-quick-product-btn"
                        class="px-4 py-2 bg-green-500 text-white text-base font-medium rounded-md w-auto shadow-sm hover:bg-green-600">Thêm</button>
                    <button id="close-quick-product-modal-btn"
                        class="px-4 py-2 bg-gray-300 text-gray-800 text-base font-medium rounded-md w-auto shadow-sm hover:bg-gray-400 ml-2">Hủy</button>
                </div>
            </div>
        </div>
    </div>

    <div id="print-invoice" class="hidden"></div>

    <!-- Modal Khôi Phục -->
    <div id="restore-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex justify-between items-center border-b pb-3 mb-4">
                    <h3 class="text-xl leading-6 font-medium text-gray-900">Khôi Phục Dữ Liệu</h3>
                    <button id="close-restore-modal" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times fa-lg"></i>
                    </button>
                </div>
                <div class="mb-4 text-sm text-gray-600 bg-yellow-50 p-3 rounded border border-yellow-200">
                    <i class="fas fa-exclamation-triangle text-yellow-500 mr-1"></i>
                    Chọn một phiên bản để khôi phục. Dữ liệu hiện tại trên máy này sẽ bị thay thế hoàn toàn.
                </div>
                <div id="backup-list" class="max-h-60 overflow-y-auto">
                    <!-- Danh sách backup sẽ được render ở đây -->
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="db.js"></script>
    <script src="supabase-client.js"></script>
    <script src="sync.js"></script>
    <script src="script.js"></script>
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then((registration) => {
                        console.log('Service Worker đã được đăng ký:', registration.scope);
                    })
                    .catch((error) => {
                        console.log('Lỗi đăng ký Service Worker:', error);
                    });
            });
        }
    </script>
    <!-- Nút làm mới ứng dụng nổi -->
    <button id="refresh-float-btn" title="Làm mới ứng dụng">
        <i class="fas fa-sync-alt"></i>
    </button>

</body>

</html>